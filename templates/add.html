<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Todo App - Welcome</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      border-radius: 16px;
      font-family: 'Segoe UI', sans-serif;
      background: url("{{ url_for('static', filename='images/uu.png') }}") no-repeat center center/cover;
      min-height: 115vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    main {
      background: url("{{ url_for('static', filename='images/it.webp') }}") no-repeat center center/cover;
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin: 2rem auto;
      overflow: hidden;
      width: 100%;
      max-width: 800px;
      border-radius: 30px;
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
    }

    h1 { color: #2B49F3; font-size: 2rem; line-height: 1.2; margin-bottom: 2rem; }
    h2 { font-family: 'Poppins', sans-serif; color: #1A3ACB; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.15); }
    h2:hover { color: #4A90E2; }

    label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
    input[type="text"], input[type="date"], input[type="time"], select {
      width: 100%;
      max-width: 300px;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.95rem;
      background-color: #f9f9f9;
      color: #333;
      transition: border 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 1rem;
      box-sizing: border-box;
    }

    input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, select:focus {
      border-color: #3f51b5;
      outline: none;
      box-shadow: 0 0 0 3px rgba(63,81,181,0.2);
    }

    .todo-header { display: flex; flex-direction: column; align-items: flex-start; gap: 1rem; margin-bottom: 2rem; padding-top: 0.5rem; }
    .search-bar { position: relative; width: 200px; }
    .search-bar input { width: 100%; padding: 0.5rem 0.5rem 0.5rem 2rem; border: 1px solid #E0E0E0; border-radius: 6px; }
    .search-bar .search-icon { position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%); color: #4A90E2; pointer-events: none; }

    .login-icon { position: absolute; top: 1rem; right: 1rem; width: 20%; height: auto; z-index: 100; }

    .todo-list { list-style: none; display: flex; flex-direction: column; gap: 1rem; padding: 0; margin: 0 0 2rem; }
    .todo-item { display: flex; align-items: center; justify-content: space-between; background-color: #D6E4FF; padding: 0.75rem 1rem; border-radius: 8px; color: #333; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .todo-item label { flex: 1; margin-left: 0.75rem; font-weight: 500; }
    .todo-item.completed label { color: #888; text-decoration: line-through; }

    .todo-item input[type="checkbox"] { appearance: none; width: 20px; height: 20px; border: 2px solid #888; border-radius: 50%; background-color: #fff; cursor: pointer; position: relative; margin-right: 0.75rem; transition: background-color 0.2s ease, border-color 0.2s ease; }
    .todo-item input[type="checkbox"]:checked { background-color: #333; border-color: #333; }
    .todo-item input[type="checkbox"]:checked::after { content: "âœ”"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); font-size: 0.75rem; color: white; line-height: 1; }

    .info-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #2B49F3; }

    .add-task-wrapper { display: flex; justify-content: flex-end; margin-top: 2rem; }
    .add-btn { display: flex; align-items: center; gap: 0.5rem; background-color: #2B49F3; color: white; padding: 0.75rem 1rem; border: none; border-radius: 24px; cursor: pointer; font-size: 1rem; transition: width 0.3s ease, padding 0.3s ease, background 0.3s ease; white-space: nowrap; overflow: hidden; width: 48px; }
    .add-btn .text { opacity: 0; transition: opacity 0.2s ease, margin 0.3s ease; margin-left: 0; }
    .add-btn:hover { width: auto; padding-right: 1.5rem; background-color: #1A3ACB; }
    .add-btn:hover .text { opacity: 1; margin-left: 0.5rem; }

    .timestamp { font-size: 0.8rem; color: #666; margin-top: 0.25rem; }

    /* Overlay / task card */
    .task-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .task-info-card { background: #fff; padding: 20px; border-radius: 10px; width: 320px; position: relative; box-shadow: 0 8px 20px rgba(0,0,0,0.2); font-family: 'Segoe UI', sans-serif; }
    .task-title { width: 100%; padding: 10px; margin-bottom: 15px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; }
    .field-row { display: flex; align-items: center; margin-bottom: 12px; gap: 8px; }
    .field-row label { flex: 1; display: flex; align-items: center; font-size: 14px; gap: 6px; }
    .field-row select { flex: 1.5; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
    .buttons { display: flex; justify-content: space-between; margin-top: 20px; }
    .update-btn { background-color: #007BFF; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .delete-btn { background-color: #DC3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .close-btn { position: absolute; bottom: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; }

    @media (max-width: 600px) {
      main { padding: 1rem; margin: 0; border-radius: 8px; }
      .todo-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      .todo-header h1 { font-size: 1.8rem; }
      .search-bar { width: 100%; }
      .add-btn { width: 100%; justify-content: center; font-size: 1rem; }
      .todo-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .task-info-card { width: 90%; max-width: 350px; }
    }
  </style>
</head>
<body>
  <main>
    <header class="todo-header">
      <h1>Welcome, {{ session.username }}</h1>
      <div class="search-bar">
        <input type="text" placeholder="Search tasks..." />
        <span class="search-icon"><i class="fas fa-search"></i></span>
      </div>
      <img src="{{ url_for('static', filename='images/do.png') }}" alt="To-Do Icon" class="login-icon" />
      <div class="filter-wrapper">
        <form method="GET" action="/">
          <select name="filter" onchange="this.form.submit()">
            <option value="">-- Filter Tasks --</option>
            <option value="pending" {% if request.args.get('filter') == 'pending' %}selected{% endif %}>Pending</option>
            <option value="completed" {% if request.args.get('filter') == 'completed' %}selected{% endif %}>Completed</option>
            <option value="high" {% if request.args.get('filter') == 'high' %}selected{% endif %}>High Priority</option>
            <option value="medium" {% if request.args.get('filter') == 'medium' %}selected{% endif %}>Medium Priority</option>
            <option value="low" {% if request.args.get('filter') == 'low' %}selected{% endif %}>Low Priority</option>
          </select>
        </form>
      </div>
    </header>

    <div class="add-task-wrapper">
      <a href="{{ url_for('add_page') }}">
        <button class="add-btn" aria-label="Add Task">
          <span class="plus"><i class="fa-solid fa-plus"></i></span>
          <span class="text">Add Task</span>
        </button>
      </a>
    </div>

    <section>
      <h2>Pending Tasks</h2>
      <ul class="todo-list">
        {% if pending_tasks %}
          {% for task in pending_tasks %}
            <li class="todo-item">
              <input type="checkbox" id="task{{ task.id }}" />
              <label for="task{{ task.id }}">{{ task.task }}</label>
              <button class="info-btn" aria-label="Task info"><i class="fa-solid fa-circle-info"></i></button>
            </li>
          {% endfor %}
        {% else %}
          <li>No pending tasks</li>
        {% endif %}
      </ul>
    </section>

    <section>
      <h2>Completed Tasks</h2>
      <ul class="todo-list">
        {% if completed_tasks %}
          {% for task in completed_tasks %}
            <li class="todo-item completed">
              <input type="checkbox" id="task{{ task.id }}" checked disabled />
              <label for="task{{ task.id }}">
                {{ task.task }}
                <span class="timestamp">Completed at {{ task.completed_at }}</span>
              </label>
              <button class="info-btn" aria-label="Task info"><i class="fa-solid fa-circle-info"></i></button>
            </li>
          {% endfor %}
        {% else %}
          <li>No completed tasks</li>
        {% endif %}
      </ul>
    </section>
<!-- Overlay / Add Task Fields (Corrected) -->
<form method="POST" action="{% if task %}{{ url_for('update_task', task_id=task.id) }}{% else %}{{ url_for('create_task') }}{% endif %}">
  <div class="task-overlay">
    <div class="task-info-card">
      <a href="{{ url_for('homepage') }}" class="close-btn">&times;</a>

      <input type="text" name="task" class="task-title" placeholder="Task Title" value="{{ task.task if task else '' }}" required>

      <div class="field-row">
        <label><i class="fa-solid fa-calendar"></i> Date:</label>
        <input type="date" name="date_due" value="{{ task.due_date.strftime('%Y-%m-%d') if task and task.due_date else '' }}">
      </div>

      <div class="field-row">
        <label><i class="fa-solid fa-clock"></i> Time:</label>
        <input type="time" name="time_due" value="{{ task.due_date.strftime('%H:%M') if task and task.due_date else '' }}">
      </div>

      <div class="field-row">
        <label><i class="fa-solid fa-flag"></i> Priority:</label>
        <select name="priority">
          <option value="">None</option>
          <option value="low" {% if task and task.priority.value == 'low' %}selected{% endif %}>Low</option>
          <option value="medium" {% if task and task.priority.value == 'medium' %}selected{% endif %}>Medium</option>
          <option value="high" {% if task and task.priority.value == 'high' %}selected{% endif %}>High</option>
        </select>
      </div>

      <div class="field-row">
        <label><i class="fa-solid fa-tags"></i> Tags:</label>
        <input type="text" name="tags" value="{{ task.tags if task else '' }}">
      </div>

      <div class="buttons">
        <!-- Update/Save Button -->
        <button type="submit" class="update-btn">{% if task %}Update{% else %}Save{% endif %}</button>

        {% if task %}
        <!-- Delete Button triggers separate form -->
        <button type="submit" class="delete-btn" form="delete-form" onclick="return confirm('Are you sure you want to delete this task?');">Delete</button>
        {% endif %}
      </div>
    </div>
  </div>
</form>

{% if task %}
<!-- Hidden Delete Form (MOVED OUTSIDE the main form) -->
<form id="delete-form" method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" style="display:none;"></form>
{% endif %}

        
  </main>
</body>
</html>