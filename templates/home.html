<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Todo App - Welcome</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

  <style>
    /* Importing the chosen font family */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    /* Reset and base styles */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-family: 'Segoe UI', sans-serif;
  margin: 0;               
  padding: 0;              
  min-height: 115vh;     
  display: flex;
  justify-content: center;
  align-items: center;

  /*responsive background */
  background-image: url("{{ url_for('static', filename='images/uu.png') }}");
  background-repeat: no-repeat;
  background-position: center center;
  background-size: cover;   /* ensures full coverage */
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}

main {
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin: 2rem auto;
      overflow: hidden;
      width: 100%;
      max-width: 680px;
      border-radius: 30px;
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
      background-color: white;
      background: url("{{ url_for('static', filename='images/it.webp') }}") no-repeat center center/cover;
    }


    h1 {
      color: #2B49F3;
      font-size: 2rem;
      line-height: 1.2;
      text-align: left;
      margin-bottom: 2rem;
    }

    label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }

          input[type="text"]:focus { outline: none; border-color: #333; }
        input[type="text"], input[type="date"], input[type="time"], select {
        width: 90%;
        max-width: 300px;
        padding: 0.5rem 0.75rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 0.95rem;
        background-color: #f9f9f9;
        color: #333;
        transition: border 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1rem;
        box-sizing: border-box;
      }

      select:focus {
        border-color: #3f51b5;
        outline: none;
        box-shadow: 0 0 0 3px rgba(63,81,181,0.2);
      }

    .todo-list { list-style: none; padding: 0; margin: 0 0 2rem; display: flex; flex-direction: column; gap: 1rem; }

    .todo-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #D6E4FF;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      color: #333333;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .todo-item label { flex: 1; margin-left: 0.75rem; font-weight: 500; }

    .timestamp { display: block; font-size: 0.8rem; color: #666; margin-top: 0.25rem; }

    .info-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #2B49F3; }

    .add-task-wrapper { display: flex; justify-content: flex-end; margin-top: 0.3rem; flex: 1 1 auto; }

    .add-btn {
      display: flex; align-items: center; gap: 0.3rem; margin-top: 0.5rem; background-color: #2B49F3;
      color: white; padding: 0.75rem 1rem; border: none; border-radius: 24px;
      cursor: pointer; font-size: 1rem; transition: width 0.3s ease, padding 0.3s ease, background 0.3s ease;
      white-space: nowrap; overflow: hidden; width: 48px;
    }

    .add-btn .text { opacity: 0; transition: opacity 0.2s ease, margin 0.3s ease; margin-left: 0; }
    .add-btn:hover { width: auto; padding-right: 1.5rem; background-color: #1A3ACB; }
    .add-btn:hover .text { opacity: 1; margin-left: 0.5rem; }

    .todo-item.completed label { color: #888888; text-decoration: line-through; }

    .todo-item input[type="checkbox"] {
      appearance: none; width: 20px; height: 20px; border: 2px solid #888; border-radius: 50%;
      background-color: #fff; cursor: pointer; position: relative; margin-right: 0.75rem;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .todo-item input[type="checkbox"]:checked {
      background-color: #333; border-color: #333;
    }

    .todo-item input[type="checkbox"]:checked::after {
      content: "✔"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%);
      font-size: 0.75rem; color: white; line-height: 1;
    }

        .todo-header {
      display: flex;
      flex-direction: column; /* stack items vertically */
      align-items: flex-start; /* align to left */
      gap: 1rem;
      margin-bottom: 2rem;
      padding-top: 0.5rem;
    }

    .todo-header h1 {
      font-size: 2rem;
    }

          .search-bar {
        position: relative; /* container relative for absolute icon */
        width: 200px;       /* or flex: 1 for responsive */
      }

    .search-bar input {
        width: 100%;
        padding: 0.3rem 0.3rem 0.3rem 1.6rem; /* leave space for icon */
        border: 1px solid #E0E0E0;
        border-radius: 6px;
      }

      .search-bar .search-icon {
        position: absolute; 
        left: 0.3rem;
        top: 38%;
        transform: translateY(-50%);
        color: #4A90E2;
        pointer-events: none; 
      }

      .filter-wrapper select {margin-bottom: 0.1rem; padding: 0.4rem 0.6rem; font-size: 0.9rem; border-radius: 6px; border: 1px solid #E0E0E0; max-width: 150px; cursor: pointer;}


    .logout-btn {
      background-color: #ff4d4d;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .logout-btn:hover {
      background-color: #cc0000;
    }

    @media (max-width: 768px) {
      .logout-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 600px) {
      .logout-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
      }
    }

    /* Shake animation for alarm popup */
@keyframes shake {
  0% { transform: translate(0px, 0px); }
  20% { transform: translate(-2px, 0px); }
  40% { transform: translate(2px, 0px); }
  60% { transform: translate(-2px, 0px); }
  80% { transform: translate(2px, 0px); }
  100% { transform: translate(0px, 0px); }
}

.alarm-shake {
  animation: shake 0.5s infinite;
}
  
/* RESPONSIVENESS */ 
   /* Mobile-first adjustments */
@media (max-width: 768px) {
      main { padding: 1.5rem; border-radius: 20px; max-width: 80%; }
      .login-icon { width: 20%; }
    }

   
/* Prevent Add Task button expansion on mobile */
@media (max-width: 600px) {
  .add-btn {
    width: 48px !important;
    padding: 0.75rem !important;
  }
  .add-btn .text {
    display: none !important;
  }
  .add-btn:hover {
    width: 48px !important;
    padding: 0.75rem !important;
    background-color: #2B49F3;
  }

  .add-task-wrapper {
    position: static;       /* No floating */
    margin-top: 1rem;       /* space below filter */
    display: flex;
    justify-content: flex-end; 
  }
}

  /* Mobile responsiveness */
@media (max-width: 1024px) {
  body {
    background-size: auto 100%;   
    background-position: center; 
    background-repeat: no-repeat;
  }
}

@media (max-width: 768px) {
  body {
    background-size: auto 100%;      
    background-position: center;
    background-repeat: no-repeat;
  }
}

@media (max-width: 480px) {
  body {
    background-size: auto 100%;      /* full height */
    background-position: center;
    background-repeat: no-repeat;
  }
}

/* 🔹 Mobile-specific full background image */
@media (max-width: 768px) {
  body {
    background-image: url("{{ url_for('static', filename='images/ui.png') }}") !important;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    background-size: cover;          
    background-position: center;     
    background-repeat: no-repeat;    
    background-attachment: fixed;   
    min-height: 115vh;               
    width: 95%;                   
  }
}

@media (max-width: 480px) {
  body {
    background-image: url("{{ url_for('static', filename='images/ui.png') }}") !important;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    min-height: 115vh;
    width: 95%;
  }
}

/* Applying the font and color to subtitles */
h2 {
  font-family: 'Poppins', sans-serif;
  color: #1A3ACB;       /* Captivating, darker blue */
  font-weight: 600;      /* Bold for emphasis */
  text-shadow: 1px 1px 2px rgba(0,0,0,0.15); /* subtle shadow */
}

h2:hover {
  color: #4A90E2; /* Accent blue on hover */
}
.header-top {
  display: flex;
  justify-content: space-between; /* username left, icon right */
  align-items: center;            /* vertical alignment */
  width: 100%;
  margin-bottom: 1rem;
}
        .login-icon {
            top: 2rem;   
            right: 1.5rem; 
            width: 30%;  
            height: auto; 
            flex-shrink: 0; 
            z-index: 10; 
          }
            @media (max-width: 768px) {
          .login-icon {
            width: 100px;  /* slightly smaller on tablets */
          }
        }

        /* Small screens */
        @media (max-width: 480px) {
          .login-icon {
            width: 80px;   /* small but still visible on phones */
          }
        }


/* Reminder */ 
.timestamp i.fa-bell { color: #FFB000; margin-right: 4px; font-size: 0.8rem; vertical-align: middle; } 
.timestamp.upcoming { color: #FF4D4D; /* red for upcoming */ font-weight: 600; }

  </style>
</head>
<body data-home-url="{{ url_for('homepage') }}">
  <main>
      <header class="todo-header">
  <div class="header-top">
    <h1>Welcome, {{ session.username }}</h1>
    <img src="{{ url_for('static', filename='images/do.png') }}" alt="To-Do Icon" class="login-icon" />
  </div>

      <!-- Search bar below username -->
    <form method="GET" action="/" class="search-bar">
   <i class="fas fa-search search-icon"></i>
    <input type="text" name="search" placeholder="Search tasks..." value="{{ request.args.get('search', '') }}"/>
   </form>
      <div class="filter-wrapper">
  <form method="GET" action="/">
    <select name="filter" onchange="this.form.submit()">
      <option value="">-- Filter Tasks --</option>
      <option value="pending" {% if request.args.get('filter') == 'pending' %}selected{% endif %}>Pending</option>
      <option value="completed" {% if request.args.get('filter') == 'completed' %}selected{% endif %}>Completed</option>
      <option value="high" {% if request.args.get('filter') == 'high' %}selected{% endif %}>High Priority</option>
      <option value="medium" {% if request.args.get('filter') == 'medium' %}selected{% endif %}>Medium Priority</option>
      <option value="low" {% if request.args.get('filter') == 'low' %}selected{% endif %}>Low Priority</option>
    </select>
  </form>
</div>
    <a href="{{ url_for('logout') }}" class="logout-btn" aria-label="Logout">
      <i class="fa-solid fa-sign-out-alt"></i>
      <span>Logout</span>
    </a>
    </header>

   <div class="add-task-wrapper">
      <a href="{{ url_for('add_page') }}" class="add-btn" aria-label="Add Task">
        <span class="plus"><i class="fa-solid fa-plus"></i></span>
        <span class="text">Add Task</span>
      </a>
    </div>

<section>
  <h2>Pending Tasks</h2>
  <ul class="todo-list">
    {% if pending_tasks %}
      {% for task in pending_tasks %}
        <li class="todo-item">
          <form method="POST" action="{{ url_for('complete_task', task_id=task.id) }}">
            <input type="checkbox" id="task{{ task.id }}" onchange="this.form.submit()"/>
            <label for="task{{ task.id }}">
              {{ task.task }}
              <div class="timestamp" style="margin-top: 4px; font-size: 0.85rem; color: #555;">
                {% if task.reminder_datetime %}
                  <i class="fa-solid fa-bell" style="color:#FFB000;"></i>
                  {{ task.reminder_datetime.strftime('Date: %d-%m-%Y, Time: %H:%M') }}
                {% else %}
                  {{ task.due_date.strftime('Date: %d-%m-%Y, Time: %H:%M') if task.due_date else 'No date set' }}
                {% endif %}
              </div>
            </label>
          </form>
          <button class="info-btn" onclick="location.href='{{ url_for('add_page') }}?task_id={{ task.id }}'">
            <i class="fa-solid fa-circle-info"></i>
          </button>
        </li>
      {% endfor %}
    {% else %}
      <li>No pending tasks</li>
    {% endif %}
  </ul>
</section>

<section>
  <h2>Completed Tasks</h2>
  <ul class="todo-list">
    {% if completed_tasks %}
      {% for task in completed_tasks %}
        <li class="todo-item completed">
          <form method="POST" action="{{ url_for('reopen_task', task_id=task.id) }}">
            <input type="checkbox" id="task{{ task.id }}" checked onchange="this.form.submit()"/>
            <label for="task{{ task.id }}">
              {{ task.task }}
              <div class="timestamp" style="margin-top: 4px; font-size: 0.85rem; color: #888;">
                Completed at Date: {{ task.completed_at.strftime('%d-%m-%Y') }}, Time: {{ task.completed_at.strftime('%H:%M') }}
              </div>
            </label>
          </form>
          <button class="info-btn" onclick="location.href='{{ url_for('add_page') }}?task_id={{ task.id }}'">
            <i class="fa-solid fa-circle-info"></i>
          </button>
        </li>
      {% endfor %}
    {% else %}
      <li>No completed tasks</li>
    {% endif %}
  </ul>
</section>


</main>

<div id="reminder-popup" style="display:none; position:fixed; bottom:20px; right:20px; 
     background:#fff; border:2px solid #2B49F3; border-radius:12px; padding:1rem 1.5rem; 
     box-shadow:0 4px 15px rgba(0,0,0,0.2); z-index:10000; width:280px;">
    <div id="reminder-text" style="font-weight:600; margin-bottom:0.5rem;"></div>
    <div style="display:flex; justify-content:space-between; gap:0.5rem;">
        <button id="snooze-btn" style="flex:1; padding:0.5rem; background:#FFD166; border:none; border-radius:8px; cursor:pointer;">Snooze 5 min</button>
        <button id="stop-btn" style="flex:1; padding:0.5rem; background:#EF476F; border:none; border-radius:8px; cursor:pointer; color:white;">Stop</button>
    </div>
</div>



<script>
// ==========================================
// Browser Reminder + Alarm + Draggable Popup + Snooze + Stop + Shake Animation
// ==========================================
const triggeredTasks = new Map();
const activeAlarms = new Map();

async function checkPendingReminders() {
    try {
        const response = await fetch("/api/pending_reminders");
        const data = await response.json();
        const tasks = data.tasks || [];
        const now = new Date();

        tasks.forEach(task => {
            if (!task.reminder_datetime || triggeredTasks.has(task.id)) return;

            const reminderTime = new Date(task.reminder_datetime);
            const delay = reminderTime.getTime() - now.getTime();

            if (delay > 0) {
                const timeoutId = setTimeout(() => showAlarm(task), delay);
                triggeredTasks.set(task.id, timeoutId);
            }
        });
    } catch (err) {
        console.error("Error fetching reminders:", err);
    }
}

function showAlarm(task) {
    // Play alarm sound continuously
    const alarm = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
    alarm.loop = true;
    alarm.volume = 1;
    alarm.play();
    activeAlarms.set(task.id, alarm);

    // Create in-page draggable popup with shake
    createAlarmPopup(task);
}

function createAlarmPopup(task) {
    const existing = document.getElementById(`alarm-popup-${task.id}`);
    if (existing) existing.remove();

    const popup = document.createElement("div");
    popup.id = `alarm-popup-${task.id}`;
    popup.classList.add("alarm-shake"); 
    popup.style.position = "fixed";
    popup.style.maxWidth = "300px";
    popup.style.left = "50%";               
    popup.style.transform = "translateX(-50%)"; 
    popup.style.background = "#fff";
    popup.style.padding = "1rem 1.5rem";
    popup.style.borderRadius = "12px";
    popup.style.boxShadow = "0 4px 12px rgba(0,0,0,0.25)";
    popup.style.zIndex = 9999;
    popup.style.minWidth = "250px";
    popup.style.fontFamily = "'Poppins', sans-serif";
    popup.style.color = "#333";
    popup.style.display = "flex";
    popup.style.flexDirection = "column";
    popup.style.gap = "0.5rem";
    popup.style.cursor = "move";

    const title = document.createElement("div");
    title.textContent = `⏰ Reminder: ${task.title}`;
    title.style.fontWeight = "600";
    popup.appendChild(title);

    const btnContainer = document.createElement("div");
    btnContainer.style.display = "flex";
    btnContainer.style.justifyContent = "space-between";
    btnContainer.style.gap = "0.5rem";

    const snoozeBtn = document.createElement("button");
    snoozeBtn.textContent = "Snooze 5 min";
    styleButton(snoozeBtn, "#FFB000");
    snoozeBtn.onclick = () => {
        snoozeTask(task.id);
        popup.remove();
    };

    const stopBtn = document.createElement("button");
    stopBtn.textContent = "Stop";
    styleButton(stopBtn, "#FF4D4D");
    stopBtn.onclick = () => {
        stopAlarm(task.id);
        popup.remove();
    };

    btnContainer.appendChild(snoozeBtn);
    btnContainer.appendChild(stopBtn);
    popup.appendChild(btnContainer);

    document.body.appendChild(popup);

    makeDraggable(popup);
}

function styleButton(btn, color) {
    btn.style.flex = "1";
    btn.style.padding = "0.5rem";
    btn.style.border = "none";
    btn.style.borderRadius = "8px";
    btn.style.background = color;
    btn.style.color = "#fff";
    btn.style.cursor = "pointer";
}

function makeDraggable(element) {
    let offsetX = 0, offsetY = 0, mouseX = 0, mouseY = 0;
    element.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e.preventDefault();
        mouseX = e.clientX;
        mouseY = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e.preventDefault();
        offsetX = mouseX - e.clientX;
        offsetY = mouseY - e.clientY;
        mouseX = e.clientX;
        mouseY = e.clientY;
        element.style.top = (element.offsetTop - offsetY) + "px";
        element.style.left = (element.offsetLeft - offsetX) + "px";
        element.style.bottom = "auto";
        element.style.right = "auto";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
}

function stopAlarm(taskId) {
    if (activeAlarms.has(taskId)) {
        const alarm = activeAlarms.get(taskId);
        alarm.pause();
        alarm.currentTime = 0;
        activeAlarms.delete(taskId);
    }
    triggeredTasks.delete(taskId);
    const popup = document.getElementById(`alarm-popup-${taskId}`);
    if (popup) popup.remove();
}

async function snoozeTask(taskId) {
    try {
        const response = await fetch(`/snooze/${taskId}`, { method: "POST" });
        const data = await response.json();
        if (data.success) {
            console.log(`Task ${taskId} snoozed for 5 minutes`);
            stopAlarm(taskId);

            const timeoutId = setTimeout(async () => {
                const taskRes = await fetch("/api/pending_reminders");
                const tasksData = await taskRes.json();
                const task = tasksData.tasks.find(t => t.id === taskId);
                if (task) showAlarm(task);
            }, 5 * 60 * 1000);

            triggeredTasks.set(taskId, timeoutId);
        }
    } catch (err) {
        console.error("Error snoozing task:", err);
    }
}

checkPendingReminders();
setInterval(checkPendingReminders, 30000);
</script>



</body>
</html>